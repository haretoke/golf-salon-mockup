<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¼šå“¡ç™»éŒ² - Step 5 | Golf Salon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Noto+Serif+JP:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script>
      async function loadTailwindConfig() {
        try {
          const response = await fetch("css/tailwind-v4-config.css");
          const cssContent = await response.text();

          const styleElement = document.createElement("style");
          styleElement.type = "text/tailwindcss";
          styleElement.textContent = cssContent;

          document.head.appendChild(styleElement);
        } catch (error) {
          console.error("Tailwindè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }
      }

      loadTailwindConfig();
    </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="js/utils/signup-flow.js"></script>

    <!-- Robot Payment JavaScript Libraries -->
    <script
      type="text/javascript"
      src="https://credit.j-payment.co.jp/gateway/js/jquery.js"
    ></script>
    <!--â€»1-->
    <script
      type="text/javascript"
      src="https://credit.j-payment.co.jp/gateway/js/CPToken.js"
    ></script>
    <!--â€»2-->
    <script
      type="text/javascript"
      src="https://credit.j-payment.co.jp/gateway/js/EMV3DSAdapter.js"
    ></script>
    <!--â€»3-->
  </head>
  <body
    class="bg-gradient-to-b from-white via-gray-100 to-gray-light min-h-screen"
  >
    <div
      class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8"
    >
      <div class="max-w-4xl w-full space-y-8">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center">
          <div
            class="mx-auto h-12 w-12 bg-green-gradient rounded-full flex items-center justify-center"
          >
            <i data-lucide="circle-dot" class="w-6 h-6 text-white"></i>
          </div>
          <h1 class="mt-6 text-3xl font-bold text-gray-900">Golf Salon</h1>
          <p class="mt-2 text-sm text-gray-600">
            ã‚´ãƒ«ãƒ•ä¸Šé”ã®ãŸã‚ã®ç‰¹åˆ¥ãªå­¦ç¿’ç©ºé–“
          </p>
        </div>

        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div class="flex items-center justify-center mb-8 px-2">
          <div
            class="flex items-center space-x-1 sm:space-x-2 overflow-x-auto max-w-full"
          >
            <!-- Step 1: Completed -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 bg-dark-green text-white rounded-full flex items-center justify-center text-xs font-medium"
              >
                <i data-lucide="check" class="w-4 h-4"></i>
              </div>
              <span
                class="ml-1 text-xs font-medium text-gray-600 hidden sm:inline"
                >ãƒ¡ãƒ¼ãƒ«</span
              >
            </div>

            <div class="w-10 h-1 bg-dark-green rounded"></div>

            <!-- Step 2: Completed -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 bg-dark-green text-white rounded-full flex items-center justify-center text-xs font-medium"
              >
                <i data-lucide="check" class="w-4 h-4"></i>
              </div>
              <span
                class="ml-1 text-xs font-medium text-gray-600 hidden sm:inline"
                >èªè¨¼</span
              >
            </div>

            <div class="w-10 h-1 bg-dark-green rounded"></div>

            <!-- Step 3: Completed -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 bg-dark-green text-white rounded-full flex items-center justify-center text-xs font-medium"
              >
                <i data-lucide="check" class="w-4 h-4"></i>
              </div>
              <span
                class="ml-1 text-xs font-medium text-gray-600 hidden sm:inline"
                >åŸºæœ¬æƒ…å ±</span
              >
            </div>

            <div class="w-10 h-1 bg-dark-green rounded"></div>

            <!-- Step 4: Completed -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 bg-dark-green text-white rounded-full flex items-center justify-center text-xs font-medium"
              >
                <i data-lucide="check" class="w-4 h-4"></i>
              </div>
              <span
                class="ml-1 text-xs font-medium text-gray-600 hidden sm:inline"
                >ãƒ—ãƒ©ãƒ³</span
              >
            </div>

            <div class="w-10 h-1 bg-primary-green rounded"></div>

            <!-- Step 5: Active -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 bg-primary-green text-white rounded-full flex items-center justify-center text-xs font-medium"
              >
                5
              </div>
              <span
                class="ml-1 text-xs font-medium text-primary-600 hidden sm:inline"
                >æ”¯æ‰•ã„</span
              >
            </div>
          </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="space-y-8">
            <div class="text-center">
              <h2 class="text-2xl font-bold text-gray-900 mb-2">
                æ”¯æ‰•ã„æƒ…å ±ã‚’å…¥åŠ›
              </h2>
              <p class="text-sm text-gray-600">
                å®‰å…¨ãªæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã§æœˆé¡ãƒ—ãƒ©ãƒ³ã®æ”¯æ‰•ã„è¨­å®šã‚’è¡Œã„ã¾ã™
              </p>
            </div>

            <!-- é¸æŠãƒ—ãƒ©ãƒ³ç¢ºèª -->
            <div id="selected-plan-summary" class="bg-gray-50 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                é¸æŠãƒ—ãƒ©ãƒ³
              </h3>
              <div class="flex justify-between items-center">
                <div>
                  <span id="plan-name" class="font-medium text-gray-900"
                    >ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ—ãƒ©ãƒ³</span
                  >
                  <p class="text-sm text-gray-600">æœˆé¡åˆ©ç”¨æ–™ï¼ˆç¨è¾¼ã¿ï¼‰</p>
                </div>
                <div class="text-right">
                  <span
                    id="plan-price"
                    class="text-2xl font-bold text-primary-green"
                    >Â¥6,600</span
                  >
                  <p class="text-sm text-gray-600">æ¯æœˆè«‹æ±‚</p>
                </div>
              </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div
              id="error-message"
              class="hidden bg-red-50 border border-red-200 rounded-lg p-4"
            >
              <div class="flex items-center">
                <i
                  data-lucide="alert-circle"
                  class="w-5 h-5 text-red-600 mr-3"
                ></i>
                <div class="flex-1">
                  <p class="text-sm text-red-800" id="error-text"></p>
                </div>
              </div>
            </div>

            <!-- ã‚«ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div
              id="card-input-modal"
              class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden"
            >
              <div
                class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto"
              >
                <div class="p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                      ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›
                    </h3>
                    <button
                      id="close-modal-btn"
                      class="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                      <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                  </div>

                  <div
                    class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3"
                  >
                    <div class="flex items-start">
                      <i
                        data-lucide="shield-check"
                        class="w-4 h-4 text-blue-600 mr-2 mt-0.5"
                      ></i>
                      <div class="text-xs text-blue-800">
                        <p class="font-medium">å®‰å…¨ãªæ¥ç¶š</p>
                        <p>
                          ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯æ±ºæ¸ˆä»£è¡Œä¼šç¤¾ã«ç›´æ¥é€ä¿¡ã•ã‚Œã€æš—å·åŒ–ã•ã‚Œã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                  <div
                    id="modal-error-message"
                    class="hidden mb-4 bg-red-50 border border-red-200 rounded-lg p-3"
                  >
                    <div class="flex items-start">
                      <i
                        data-lucide="alert-circle"
                        class="w-4 h-4 text-red-600 mr-2 mt-0.5"
                      ></i>
                      <div class="text-xs text-red-800">
                        <p class="font-medium">å…¥åŠ›ã‚¨ãƒ©ãƒ¼</p>
                        <p id="modal-error-text"></p>
                      </div>
                    </div>
                  </div>

                  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å†…æˆåŠŸè¡¨ç¤º -->
                  <div
                    id="modal-success-message"
                    class="hidden mb-4 bg-green-50 border border-green-200 rounded-lg p-3"
                  >
                    <div class="flex items-start">
                      <i
                        data-lucide="check-circle"
                        class="w-4 h-4 text-green-600 mr-2 mt-0.5"
                      ></i>
                      <div class="text-xs text-green-800">
                        <p class="font-medium">èªè¨¼å®Œäº†</p>
                        <p id="modal-success-text">
                          ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚
                        </p>
                      </div>
                    </div>
                  </div>

                  <form id="card-modal-form" class="space-y-4">
                    <div>
                      <label
                        for="modal-cardNumber"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        ã‚«ãƒ¼ãƒ‰ç•ªå·
                      </label>
                      <div class="relative">
                        <input
                          type="text"
                          id="modal-cardNumber"
                          name="cardNumber"
                          required
                          maxlength="19"
                          placeholder="1234 5678 9012 3456"
                          class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent"
                        />
                        <div
                          class="absolute inset-y-0 right-0 pr-3 flex items-center"
                        >
                          <i
                            id="card-number-status"
                            class="w-4 h-4 text-gray-400 hidden"
                            data-lucide="check-circle"
                          ></i>
                        </div>
                      </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label
                          for="modal-expiryDate"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          æœ‰åŠ¹æœŸé™
                        </label>
                        <div class="relative">
                          <input
                            type="text"
                            id="modal-expiryDate"
                            name="expiryDate"
                            required
                            maxlength="5"
                            placeholder="MM/YY"
                            class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent"
                          />
                          <div
                            class="absolute inset-y-0 right-0 pr-2 flex items-center"
                          >
                            <i
                              id="expiry-status"
                              class="w-3 h-3 text-gray-400 hidden"
                              data-lucide="check-circle"
                            ></i>
                          </div>
                        </div>
                      </div>

                      <div>
                        <label
                          for="modal-cvv"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰
                        </label>
                        <div class="relative">
                          <input
                            type="text"
                            id="modal-cvv"
                            name="cvv"
                            required
                            maxlength="4"
                            placeholder="123"
                            class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent"
                          />
                          <div
                            class="absolute inset-y-0 right-0 pr-2 flex items-center"
                          >
                            <i
                              id="cvv-status"
                              class="w-3 h-3 text-gray-400 hidden"
                              data-lucide="check-circle"
                            ></i>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label
                        for="modal-cardHolder"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        ã‚«ãƒ¼ãƒ‰åç¾©äºº
                      </label>
                      <div class="relative">
                        <input
                          type="text"
                          id="modal-cardHolder"
                          name="cardHolder"
                          required
                          placeholder="TANAKA TARO"
                          style="text-transform: uppercase"
                          class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green focus:border-transparent"
                        />
                        <div
                          class="absolute inset-y-0 right-0 pr-3 flex items-center"
                        >
                          <i
                            id="cardholder-status"
                            class="w-4 h-4 text-gray-400 hidden"
                            data-lucide="check-circle"
                          ></i>
                        </div>
                      </div>
                    </div>

                    <div class="flex space-x-3 pt-4">
                      <button
                        type="button"
                        id="cancel-card-btn"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                      >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </button>
                      <button
                        type="submit"
                        id="save-card-btn"
                        class="flex-1 bg-primary-green text-white px-4 py-2 rounded-lg hover:bg-primary-dark-green focus:outline-none focus:ring-2 focus:ring-primary-green focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <span class="flex items-center justify-center">
                          <span id="save-card-btn-text">ã‚«ãƒ¼ãƒ‰ç™»éŒ²</span>
                          <div
                            id="save-card-loading-spinner"
                            class="hidden ml-2"
                          >
                            <svg
                              class="animate-spin h-4 w-4 text-white"
                              viewBox="0 0 24 24"
                            >
                              <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke="currentColor"
                                stroke-width="4"
                              ></circle>
                              <path
                                class="opacity-75"
                                fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                              ></path>
                            </svg>
                          </div>
                        </span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- æ”¯æ‰•ã„ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form id="payment-form" class="space-y-8">
              <!-- Robot Payment Token Fields (Hidden) -->
              <input type="hidden" id="tkn" name="tkn" value="" />
              <input type="hidden" id="card-token" name="cardToken" />
              <input type="hidden" id="auth-veres" name="authVeres" />
              <input type="hidden" id="auth-pares" name="authPares" />

              <!-- 3Dã‚»ã‚­ãƒ¥ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºç”¨ -->
              <div id="EMV3DS_INPUT_FORM"></div>

              <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠ -->
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-900">æ”¯æ‰•ã„æ–¹æ³•</h3>
                <div class="grid grid-cols-1 gap-3">
                  <label class="payment-method cursor-pointer">
                    <input
                      type="radio"
                      name="paymentMethod"
                      value="creditcard"
                      class="sr-only"
                      checked
                    />
                    <div
                      class="border-2 border-primary-green bg-primary-50 rounded-lg p-4 flex items-center"
                    >
                      <i
                        data-lucide="credit-card"
                        class="w-5 h-5 text-primary-green mr-3"
                      ></i>
                      <span class="font-medium text-gray-900"
                        >ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span
                      >
                      <div class="ml-auto flex space-x-2">
                        <img src="./images/visa.svg" alt="Visa" class="h-6" />
                        <img
                          src="./images/mastercard.svg"
                          alt="Mastercard"
                          class="h-6"
                        />
                        <img src="./images/jcb.svg" alt="JCB" class="h-6" />
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <div id="credit-card-section" class="space-y-6">
                <h3 class="text-lg font-semibold text-gray-900">
                  æœˆé¡èª²é‡‘ç”¨ã‚«ãƒ¼ãƒ‰ç™»éŒ²
                </h3>

                <!-- ã‚«ãƒ¼ãƒ‰æœªç™»éŒ²æ™‚ã®è¡¨ç¤º -->
                <div id="card-not-registered" class="space-y-4">
                  <button
                    type="button"
                    id="add-card-btn"
                    class="w-full bg-primary-green text-white py-3 px-4 rounded-lg font-medium hover:bg-primary-dark-green focus:outline-none focus:ring-2 focus:ring-primary-green focus:ring-offset-2 transition-colors"
                  >
                    <span class="flex items-center justify-center">
                      <i data-lucide="credit-card" class="w-5 h-5 mr-2"></i>
                      ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å…¥åŠ›
                    </span>
                  </button>

                  <p class="text-xs text-gray-500 text-center">
                    æœˆé¡èª²é‡‘ç”¨ã®ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¾ã™
                  </p>
                </div>

                <!-- ã‚«ãƒ¼ãƒ‰ç™»éŒ²æ¸ˆã¿æ™‚ã®è¡¨ç¤º -->
                <div id="card-registered" class="hidden space-y-4">
                  <div
                    class="bg-green-50 border border-green-200 rounded-lg p-4"
                  >
                    <div class="flex items-start">
                      <i
                        data-lucide="check-circle"
                        class="w-5 h-5 text-green-600 mr-3 mt-0.5"
                      ></i>
                      <div class="text-sm text-green-800">
                        <p class="font-medium mb-1">ã‚«ãƒ¼ãƒ‰ç™»éŒ²å®Œäº†</p>
                        <p id="registered-card-info">
                          **** **** **** 1234 (Visa)
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- åˆ©ç”¨è¦ç´„ãƒ»è¿”é‡‘ãƒãƒªã‚·ãƒ¼åŒæ„ -->
              <div class="space-y-4">
                <div class="flex items-start">
                  <input
                    type="checkbox"
                    id="agree-combined-terms"
                    name="agreeCombinedTerms"
                    required
                    class="mt-1 h-4 w-4 text-primary-600 focus:ring-primary-green border-gray-300 rounded"
                  />
                  <label
                    for="agree-combined-terms"
                    class="ml-3 text-sm text-gray-700"
                  >
                    <a
                      href="legal.html#payment"
                      class="text-primary-600 hover:underline"
                      target="_blank"
                      >æ±ºæ¸ˆåˆ©ç”¨è¦ç´„</a
                    >ãŠã‚ˆã³<a
                      href="legal.html#tokusho"
                      class="text-primary-600 hover:underline"
                      target="_blank"
                      >è¿”é‡‘ãƒãƒªã‚·ãƒ¼</a
                    >ã€æ¯æœˆè‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹æœˆé¡ãƒ—ãƒ©ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—åŒæ„ã—ã¾ã™ã€‚
                  </label>
                </div>
              </div>

              <!-- æ±ºæ¸ˆãƒœã‚¿ãƒ³ -->
              <button
                type="submit"
                id="payment-btn"
                disabled
                class="w-full bg-primary-green text-white py-4 px-4 rounded-lg font-medium text-lg hover:bg-primary-dark-green focus:outline-none focus:ring-2 focus:ring-primary-green focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span class="flex items-center justify-center">
                  <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                  <span id="payment-btn-text">Â¥6,600ã§ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹</span>
                  <div id="payment-loading-spinner" class="hidden ml-2">
                    <svg
                      class="animate-spin h-5 w-5 text-white"
                      viewBox="0 0 24 24"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                      ></path>
                    </svg>
                  </div>
                </span>
              </button>

              <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ± -->
              <div class="text-center space-y-2">
                <p
                  class="text-xs text-gray-500 flex items-center justify-center"
                >
                  <i
                    data-lucide="shield-check"
                    class="w-4 h-4 mr-2 text-primary-green"
                  ></i>
                  SSLæš—å·åŒ–é€šä¿¡ã§å®‰å…¨ã«ä¿è­·ã•ã‚Œã¦ã„ã¾ã™
                </p>
                <p
                  class="text-xs text-gray-500 flex items-center justify-center"
                >
                  <i
                    data-lucide="credit-card"
                    class="w-4 h-4 mr-2 text-primary-green"
                  ></i>
                  PCI DSSæº–æ‹ ã®å®‰å…¨ãªæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ 
                </p>
                <p class="text-xs text-gray-500">
                  åˆå›è«‹æ±‚æ—¥:
                  <span id="billing-date" class="font-medium"></span>
                </p>
              </div>
            </form>
          </div>
        </div>

        <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
        <div class="text-center">
          <a
            href="signup-step4.html"
            class="text-sm text-gray-500 hover:text-gray-700"
          >
            <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
            ãƒ—ãƒ©ãƒ³é¸æŠã«æˆ»ã‚‹
          </a>
        </div>
      </div>
    </div>

    <script>
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", () => {
        if (window.lucide) {
          lucide.createIcons();
        }

        // æ”¯æ‰•ã„ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–ï¼ˆç›´æ¥å®Ÿè£…ã®ãŸã‚å¤–éƒ¨åˆæœŸåŒ–ã¯ä¸è¦ï¼‰

        // é¸æŠãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
        loadSelectedPlan();

        // ã‚«ãƒ¼ãƒ‰ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        initCardFormatting();

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        initPaymentForm();

        // ã‚«ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
        initCardModal();

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´æ™‚ã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        initCheckboxListeners();

        // åˆæœŸçŠ¶æ…‹ã§ã®æ±ºæ¸ˆãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        checkPaymentButtonStatus();
      });

      // é¸æŠãƒ—ãƒ©ãƒ³æƒ…å ±ã®èª­ã¿è¾¼ã¿
      function loadSelectedPlan() {
        const planData = JSON.parse(
          localStorage.getItem("selectedPlan") ||
            '{"type": "gold", "price": 6600, "name": "ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ—ãƒ©ãƒ³"}'
        );
        const basicInfo = JSON.parse(
          localStorage.getItem("signupBasicInfo") || "{}"
        );

        document.getElementById("plan-name").textContent = planData.name;
        document.getElementById(
          "plan-price"
        ).textContent = `Â¥${planData.price.toLocaleString()}`;
        document.getElementById(
          "payment-btn-text"
        ).textContent = `Â¥${planData.price.toLocaleString()}ã§ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹`;

        // è«‹æ±‚å…ˆéƒ½é“åºœçœŒã®è¨­å®šã¯ä¸è¦ï¼ˆè«‹æ±‚å…ˆä½æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤æ¸ˆã¿ï¼‰

        // åˆå›è«‹æ±‚æ—¥ã‚’è¨­å®šï¼ˆå³æ™‚ï¼‰
        const billingDate = new Date();
        document.getElementById("billing-date").textContent =
          "å³æ™‚ï¼ˆç™»éŒ²å®Œäº†æ™‚ï¼‰";
      }

      // ã‚«ãƒ¼ãƒ‰ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã¯åˆ¥é€”initCardModalå†…ã§å‡¦ç†ï¼‰
      function initCardFormatting() {
        // ç¾åœ¨ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«æ–¹å¼ã®ãŸã‚ã€ã“ã®é–¢æ•°ã¯ç©º
      }

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–
      function initCheckboxListeners() {
        const agreeCombinedTerms = document.getElementById(
          "agree-combined-terms"
        );

        agreeCombinedTerms.addEventListener("change", checkPaymentButtonStatus);
      }

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
      function initPaymentForm() {
        const form = document.getElementById("payment-form");
        form.addEventListener("submit", (e) => {
          e.preventDefault();

          // ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const cardToken = document.getElementById("card-token").value;
          if (!cardToken) {
            showError("ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          // ã‚«ãƒ¼ãƒ‰åŒæ„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ç¢ºèª
          const agreeCombinedTerms = document.getElementById(
            "agree-combined-terms"
          );

          if (!agreeCombinedTerms.checked) {
            showError("æ±ºæ¸ˆåˆ©ç”¨è¦ç´„ãŠã‚ˆã³è¿”é‡‘ãƒãƒªã‚·ãƒ¼ã€æœˆé¡ãƒ—ãƒ©ãƒ³ã«ã¤ã„ã¦åŒæ„ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          // æ±ºæ¸ˆå‡¦ç†é–‹å§‹
          const btn = document.getElementById("payment-btn");
          const btnText = document.getElementById("payment-btn-text");
          const spinner = document.getElementById("payment-loading-spinner");

          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’éš ã™
          hideError();

          btn.disabled = true;
          btnText.textContent = "ç™»éŒ²å®Œäº†ä¸­...";
          spinner.classList.remove("hidden");

          // ç™»éŒ²å®Œäº†å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          setTimeout(() => {
            // å…¨ã¦ã®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
            const basicInfo = JSON.parse(
              localStorage.getItem("signupBasicInfo") || "{}"
            );
            const planData = JSON.parse(
              localStorage.getItem("selectedPlan") || "{}"
            );

            const completeSignupData = {
              ...basicInfo,
              plan: planData,
              payment: {
                cardToken: cardToken,
                method: "credit_card",
                authVeres: document.getElementById("auth-veres").value,
                authPares: document.getElementById("auth-pares").value,
              },
              registrationComplete: true,
              timestamp: new Date().toISOString(),
            };

            localStorage.setItem(
              "signupComplete",
              JSON.stringify(completeSignupData)
            );

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨é·ç§»
            spinner.classList.add("hidden");
            btnText.textContent = "ç™»éŒ²å®Œäº†ï¼";
            alert(
              "ğŸ‰ ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼\\næœˆé¡èª²é‡‘ã®è¨­å®šã‚‚å®Œäº†ã—ã€Golf Salonã¸ã‚ˆã†ã“ãï¼"
            );
            // window.location.href = 'dashboard.html';
          }, 2000);
        });
      }

      // ã‚«ãƒ¼ãƒ‰ç•ªå·ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆLuhnã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
      function validateCardNumber(cardNumber) {
        const cleanNumber = cardNumber.replace(/\s/g, "");
        if (cleanNumber.length < 13 || cleanNumber.length > 19) return false;

        let sum = 0;
        let isEvenPosition = false;

        for (let i = cleanNumber.length - 1; i >= 0; i--) {
          let digit = parseInt(cleanNumber.charAt(i));

          if (isEvenPosition) {
            digit *= 2;
            if (digit > 9) {
              digit = Math.floor(digit / 10) + (digit % 10);
            }
          }

          sum += digit;
          isEvenPosition = !isEvenPosition;
        }

        return sum % 10 === 0;
      }

      // ã‚«ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      function validateExpiry(expiry) {
        const match = expiry.match(/^(\d{2})\/(\d{2})$/);
        if (!match) return false;

        const month = parseInt(match[1]);
        const year = parseInt("20" + match[2]);
        const now = new Date();
        const expDate = new Date(year, month - 1, 1);

        return month >= 1 && month <= 12 && expDate > now;
      }

      // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        const errorText = document.getElementById("error-text");
        errorText.textContent = message;
        errorDiv.classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’éš ã™
      function hideError() {
        const errorDiv = document.getElementById("error-message");
        errorDiv.classList.add("hidden");
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      function showModalError(message) {
        const errorDiv = document.getElementById("modal-error-message");
        const errorText = document.getElementById("modal-error-text");
        const successDiv = document.getElementById("modal-success-message");

        errorText.textContent = message;
        errorDiv.classList.remove("hidden");
        successDiv.classList.add("hidden");

        // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å†åˆæœŸåŒ–
        if (window.lucide) {
          lucide.createIcons();
        }
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’éš ã™
      function hideModalError() {
        const errorDiv = document.getElementById("modal-error-message");
        errorDiv.classList.add("hidden");
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…æˆåŠŸè¡¨ç¤º
      function showModalSuccess(message) {
        const successDiv = document.getElementById("modal-success-message");
        const successText = document.getElementById("modal-success-text");
        const errorDiv = document.getElementById("modal-error-message");

        successText.textContent = message;
        successDiv.classList.remove("hidden");
        errorDiv.classList.add("hidden");

        // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å†åˆæœŸåŒ–
        if (window.lucide) {
          lucide.createIcons();
        }
      }

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹è¡¨ç¤º
      function setFieldStatus(fieldId, statusId, isValid) {
        const field = document.getElementById(fieldId);
        const status = document.getElementById(statusId);

        if (isValid) {
          field.classList.remove("border-red-300", "focus:ring-red-500");
          field.classList.add("border-green-300", "focus:ring-green-500");
          status.classList.remove("hidden", "text-red-500");
          status.classList.add("text-green-500");
          status.setAttribute("data-lucide", "check-circle");
        } else {
          field.classList.remove("border-green-300", "focus:ring-green-500");
          field.classList.add("border-red-300", "focus:ring-red-500");
          status.classList.remove("hidden", "text-green-500");
          status.classList.add("text-red-500");
          status.setAttribute("data-lucide", "x-circle");
        }

        // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å†åˆæœŸåŒ–
        if (window.lucide) {
          lucide.createIcons();
        }
      }

      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      function resetFieldStatus(fieldId, statusId) {
        const field = document.getElementById(fieldId);
        const status = document.getElementById(statusId);

        field.classList.remove(
          "border-red-300",
          "border-green-300",
          "focus:ring-red-500",
          "focus:ring-green-500"
        );
        field.classList.add("border-gray-300");
        status.classList.add("hidden");
      }

      // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      function checkAllFieldsValid() {
        const cardNumber = document
          .getElementById("modal-cardNumber")
          .value.replace(/\s/g, "");
        const expiryDate = document.getElementById("modal-expiryDate").value;
        const cvv = document.getElementById("modal-cvv").value;
        const cardHolder = document
          .getElementById("modal-cardHolder")
          .value.trim();

        const cardValid =
          cardNumber.length >= 13 && validateCardNumber(cardNumber);
        const expiryValid =
          expiryDate.length === 5 && validateExpiry(expiryDate);
        const cvvValid = cvv.length >= 3 && cvv.length <= 4;
        const holderValid =
          cardHolder.length >= 2 && /^[A-Z\s]+$/.test(cardHolder);

        // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’éš ã™
        if (cardValid && expiryValid && cvvValid && holderValid) {
          hideModalError();
        }

        return cardValid && expiryValid && cvvValid && holderValid;
      }

      // ã‚«ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
      function initCardModal() {
        const addCardBtn = document.getElementById("add-card-btn");
        const modal = document.getElementById("card-input-modal");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const cancelCardBtn = document.getElementById("cancel-card-btn");
        const cardModalForm = document.getElementById("card-modal-form");

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        addCardBtn.addEventListener("click", () => {
          modal.classList.remove("hidden");
          document.body.style.overflow = "hidden";
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
          cardModalForm.reset();
          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’éš ã™
          hideError();
          hideModalError();
          // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          resetFieldStatus("modal-cardNumber", "card-number-status");
          resetFieldStatus("modal-expiryDate", "expiry-status");
          resetFieldStatus("modal-cvv", "cvv-status");
          resetFieldStatus("modal-cardHolder", "cardholder-status");
          // æœ€åˆã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          document.getElementById("modal-cardNumber").focus();
          // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å†åˆæœŸåŒ–
          if (window.lucide) {
            lucide.createIcons();
          }
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const closeModal = () => {
          modal.classList.add("hidden");
          document.body.style.overflow = "auto";
        };

        closeModalBtn.addEventListener("click", closeModal);
        cancelCardBtn.addEventListener("click", closeModal);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Escã‚­ãƒ¼ã§é–‰ã˜ã‚‹
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && !modal.classList.contains("hidden")) {
            closeModal();
          }
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const modalCardNumber = document.getElementById("modal-cardNumber");
        const modalExpiryDate = document.getElementById("modal-expiryDate");
        const modalCvv = document.getElementById("modal-cvv");
        const modalCardHolder = document.getElementById("modal-cardHolder");

        // ã‚«ãƒ¼ãƒ‰ç•ªå·ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
        modalCardNumber.addEventListener("input", (e) => {
          let value = e.target.value.replace(/\s/g, "").replace(/\D/g, "");
          value = value.replace(/(.{4})/g, "$1 ").trim();
          if (value.length > 19) value = value.substring(0, 19);
          e.target.value = value;

          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
          const cleanNumber = value.replace(/\s/g, "");
          if (cleanNumber.length >= 13) {
            const isValid = validateCardNumber(cleanNumber);
            setFieldStatus("modal-cardNumber", "card-number-status", isValid);
            if (!isValid && cleanNumber.length >= 16) {
              showModalError("ã‚«ãƒ¼ãƒ‰ç•ªå·ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            } else if (isValid) {
              // æœ‰åŠ¹ãªå ´åˆã¯å…¨ä½“çš„ãªæ¤œè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
              checkAllFieldsValid();
            }
          } else {
            resetFieldStatus("modal-cardNumber", "card-number-status");
            // å…¥åŠ›ä¸­ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„
            checkAllFieldsValid();
          }
        });

        // æœ‰åŠ¹æœŸé™ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
        modalExpiryDate.addEventListener("input", (e) => {
          const currentValue = e.target.value;
          let value = currentValue.replace(/\D/g, "");

          // 1æ¡ã§2-9ã®å ´åˆã¯å³åº§ã«è£œå®Œ
          if (
            value.length === 1 &&
            parseInt(value) >= 2 &&
            parseInt(value) <= 9
          ) {
            value = "0" + value;
          }

          // 3æ¡ã®å ´åˆï¼ˆä¾‹ï¼š112 â†’ 11/2ï¼‰
          if (value.length === 3) {
            const firstTwo = value.substring(0, 2);
            const month = parseInt(firstTwo);
            if (month >= 1 && month <= 12) {
              value = firstTwo + "/" + value.substring(2, 3);
            }
          }
          // 2æ¡ä»¥ä¸Šã®å ´åˆã¯é€šå¸¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          else if (value.length >= 2) {
            value = value.substring(0, 2) + "/" + value.substring(2, 4);
          }

          e.target.value = value;

          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
          if (value.length === 5) {
            const isValid = validateExpiry(value);
            setFieldStatus("modal-expiryDate", "expiry-status", isValid);
            if (!isValid) {
              showModalError("æœ‰åŠ¹æœŸé™ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            } else {
              // æœ‰åŠ¹ãªå ´åˆã¯å…¨ä½“çš„ãªæ¤œè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
              checkAllFieldsValid();
            }
          } else {
            resetFieldStatus("modal-expiryDate", "expiry-status");
            // å…¥åŠ›ä¸­ã®å ´åˆã‚‚å…¨ä½“ãƒã‚§ãƒƒã‚¯
            checkAllFieldsValid();
          }
        });

        // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚­ãƒ¼å…¥åŠ›æ™‚ã®ç‰¹åˆ¥å‡¦ç†
        modalExpiryDate.addEventListener("keydown", (e) => {
          if (e.key === "/") {
            e.preventDefault();
            const value = e.target.value.replace(/\D/g, "");

            // 1ã®ã¿ã®å ´åˆã¯01ã¨ã—ã¦è§£é‡ˆ
            if (value === "1") {
              e.target.value = "01/";
            }
            // ãã®ä»–ã®1æ¡ã®å ´åˆã¯ãã®ã¾ã¾/ã‚’è¿½åŠ 
            else if (value.length === 1) {
              e.target.value = "0" + value + "/";
            }
            // 2æ¡ã®å ´åˆã¯é€šå¸¸é€šã‚Š/ã‚’è¿½åŠ 
            else if (value.length === 2) {
              e.target.value = value + "/";
            }
          }
        });

        // CVVã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
        modalCvv.addEventListener("input", (e) => {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 4) value = value.substring(0, 4);
          e.target.value = value;

          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
          if (value.length >= 3) {
            const isValid = value.length >= 3 && value.length <= 4;
            setFieldStatus("modal-cvv", "cvv-status", isValid);
            if (isValid) {
              // å…¨ä½“çš„ãªæ¤œè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
              checkAllFieldsValid();
            }
          } else {
            resetFieldStatus("modal-cvv", "cvv-status");
            // å…¥åŠ›ä¸­ã®å ´åˆã‚‚å…¨ä½“ãƒã‚§ãƒƒã‚¯
            checkAllFieldsValid();
          }
        });

        // ã‚«ãƒ¼ãƒ‰ãƒ›ãƒ«ãƒ€ãƒ¼åã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
        modalCardHolder.addEventListener("input", (e) => {
          e.target.value = e.target.value.toUpperCase();

          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
          const value = e.target.value.trim();
          if (value.length >= 2) {
            const isValid = value.length >= 2 && /^[A-Z\s]+$/.test(value);
            setFieldStatus("modal-cardHolder", "cardholder-status", isValid);
            if (!isValid) {
              showModalError("ã‚«ãƒ¼ãƒ‰åç¾©äººã¯è‹±å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            } else {
              // æœ‰åŠ¹ãªå ´åˆã¯å…¨ä½“çš„ãªæ¤œè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
              checkAllFieldsValid();
            }
          } else {
            resetFieldStatus("modal-cardHolder", "cardholder-status");
            // å…¥åŠ›ä¸­ã®å ´åˆã‚‚å…¨ä½“ãƒã‚§ãƒƒã‚¯
            checkAllFieldsValid();
          }
        });

        // ã‚«ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        cardModalForm.addEventListener("submit", (e) => {
          e.preventDefault();

          const cardNumber = modalCardNumber.value.replace(/\s/g, "");
          const expiryDate = modalExpiryDate.value;
          const cvv = document.getElementById("modal-cvv").value;
          const cardHolder = modalCardHolder.value;

          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          if (!validateCardNumber(cardNumber)) {
            showModalError("ã‚«ãƒ¼ãƒ‰ç•ªå·ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          if (!validateExpiry(expiryDate)) {
            showModalError("æœ‰åŠ¹æœŸé™ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          if (cvv.length < 3 || cvv.length > 4) {
            showModalError("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          if (!cardHolder.trim()) {
            showModalError("ã‚«ãƒ¼ãƒ‰åç¾©äººã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹å¤‰æ›´
          const saveBtn = document.getElementById("save-card-btn");
          const saveBtnText = document.getElementById("save-card-btn-text");
          const saveSpinner = document.getElementById(
            "save-card-loading-spinner"
          );

          saveBtn.disabled = true;
          saveBtnText.textContent = "ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ä¸­...";
          saveSpinner.classList.remove("hidden");

          // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¨ãƒ©ãƒ¼ã‚’éš ã™
          hideModalError();

          // Robot Paymentãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å‡¦ç†
          processBillingRoboTokenFromModal(
            cardNumber,
            expiryDate,
            cvv,
            cardHolder,
            () => {
              // æˆåŠŸæ™‚ã®å‡¦ç†
              showModalSuccess("ã‚«ãƒ¼ãƒ‰èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
              setTimeout(() => {
                hideError(); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’éš ã™
                closeModal();
                // ã‚«ãƒ¼ãƒ‰ç™»éŒ²å®Œäº†è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
                showCardRegistered(cardNumber);
              }, 1500);
            },
            (error) => {
              // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
              saveBtn.disabled = false;
              saveBtnText.textContent = "ã‚«ãƒ¼ãƒ‰ç™»éŒ²";
              saveSpinner.classList.add("hidden");
              showModalError(
                "ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
              );
            }
          );
        });
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å‡¦ç†
      function processBillingRoboTokenFromModal(
        cardNumber,
        expiryDate,
        cvv,
        cardHolder,
        onSuccess,
        onError
      ) {
        try {
          const expMonth = expiryDate.split("/")[0];
          const expYear = expiryDate.split("/")[1];

          // CPToken.TokenCreateã‚’æ­£ã—ã„å½¢å¼ã§å‘¼ã³å‡ºã—
          CPToken.TokenCreate(
            {
              aid: "132563", // åº—èˆ—ID
              cn: cardNumber, // ã‚«ãƒ¼ãƒ‰ç•ªå·
              ed: expYear + expMonth, // æœ‰åŠ¹æœŸé™ï¼ˆYYMMå½¢å¼ï¼‰
              fn: cardHolder.split(" ")[0] || cardHolder, // å§“
              ln: cardHolder.split(" ")[1] || "", // å
            },
            function (resultCode, errMsg) {
              // ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆå¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
              if (resultCode !== "Success") {
                console.error("ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:", errMsg);
                onError(errMsg);
              } else {
                console.log("ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆæˆåŠŸ");
                const token = document.getElementById("tkn").value; // tknè¦ç´ ã«è‡ªå‹•ã§ã‚»ãƒƒãƒˆã•ã‚Œã‚‹
                document.getElementById("card-token").value = token; // äº’æ›æ€§ã®ãŸã‚ã«card-tokenã«ã‚‚ã‚»ãƒƒãƒˆ

                // 3Dã‚»ã‚­ãƒ¥ã‚¢èªè¨¼ã‚’å®Ÿè¡Œ
                if (window.ThreeDSAdapter) {
                  ThreeDSAdapter.authenticate(
                    {
                      tkn: token,
                      aid: "132563",
                      am: getCurrentPlanPrice(), // æ±ºæ¸ˆé‡‘é¡
                      tx: 0, // ç¨é¡
                      sf: 0, // é€æ–™
                      em: getCustomerEmail(), // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                      pn: "0000000000", // é›»è©±ç•ªå·ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
                    },
                    function (authResultCode, authErrMsg) {
                      // 3Dã‚»ã‚­ãƒ¥ã‚¢èªè¨¼å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                      if (authResultCode !== "Success") {
                        console.error("3Dã‚»ã‚­ãƒ¥ã‚¢èªè¨¼ã‚¨ãƒ©ãƒ¼:", authErrMsg);
                        onError(authErrMsg);
                      } else {
                        console.log("3Dã‚»ã‚­ãƒ¥ã‚¢èªè¨¼æˆåŠŸ");

                        // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
                        document.getElementById("modal-cardNumber").value = "";
                        document.getElementById("modal-cvv").value = "";

                        onSuccess(token);
                      }
                    }
                  );
                } else {
                  // 3Dã‚»ã‚­ãƒ¥ã‚¢ãŒç„¡åŠ¹ãªå ´åˆã¯ãã®ã¾ã¾æˆåŠŸ
                  console.log("3Dã‚»ã‚­ãƒ¥ã‚¢ç„¡åŠ¹ã®ãŸã‚ã€ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆã®ã¿å®Œäº†");
                  onSuccess(token);
                }
              }
            }
          );
        } catch (error) {
          console.error("CPTokenå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:", error);
          onError(error);
        }
      }

      // ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ã‚’å–å¾—
      function getCurrentPlanPrice() {
        const planData = JSON.parse(
          localStorage.getItem("selectedPlan") || '{"price": 6600}'
        );
        return planData.price;
      }

      // é¡§å®¢ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
      function getCustomerEmail() {
        const basicInfo = JSON.parse(
          localStorage.getItem("signupBasicInfo") || "{}"
        );
        return (
          basicInfo.email ||
          localStorage.getItem("signupEmail") ||
          "test@example.com"
        );
      }

      // æ±ºæ¸ˆãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯
      function checkPaymentButtonStatus() {
        const cardToken = document.getElementById("card-token").value;
        const agreeCombinedTerms = document.getElementById(
          "agree-combined-terms"
        ).checked;
        const paymentBtn = document.getElementById("payment-btn");

        // ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿æœ‰åŠ¹åŒ–
        if (cardToken && agreeCombinedTerms) {
          paymentBtn.classList.remove("opacity-50", "cursor-not-allowed");
          paymentBtn.disabled = false;
        } else {
          paymentBtn.classList.add("opacity-50", "cursor-not-allowed");
          paymentBtn.disabled = true;
        }
      }

      // ã‚«ãƒ¼ãƒ‰ç™»éŒ²å®Œäº†è¡¨ç¤º
      function showCardRegistered(cardNumber) {
        const cardNotRegistered = document.getElementById(
          "card-not-registered"
        );
        const cardRegistered = document.getElementById("card-registered");
        const registeredCardInfo = document.getElementById(
          "registered-card-info"
        );

        // ã‚«ãƒ¼ãƒ‰ç•ªå·ã®æœ€å¾Œ4æ¡ã‚’å–å¾—
        const lastFour = cardNumber.slice(-4);

        // ã‚«ãƒ¼ãƒ‰ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’æ¨å®š
        let cardBrand = "Card";
        if (cardNumber.startsWith("4")) {
          cardBrand = "Visa";
        } else if (cardNumber.startsWith("5") || cardNumber.startsWith("2")) {
          cardBrand = "Mastercard";
        } else if (cardNumber.startsWith("35")) {
          cardBrand = "JCB";
        }

        // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’è¡¨ç¤º
        registeredCardInfo.textContent = `**** **** **** ${lastFour} (${cardBrand})`;

        // è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        cardNotRegistered.classList.add("hidden");
        cardRegistered.classList.remove("hidden");

        // æ±ºæ¸ˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        checkPaymentButtonStatus();
      }
    </script>
  </body>
</html>
