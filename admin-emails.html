<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>メール管理 - Golf Salon Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Noto+Serif+JP:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script>
      // Tailwind v4 設定の動的読み込み
      async function loadTailwindConfig() {
        try {
          const response = await fetch('css/tailwind-v4-config.css');
          const cssContent = await response.text();
          
          // <style type="text/tailwindcss">タグを作成
          const styleElement = document.createElement('style');
          styleElement.type = 'text/tailwindcss';
          styleElement.textContent = cssContent;
          
          // headに挿入
          document.head.appendChild(styleElement);
        } catch (error) {
          console.error('Tailwind設定の読み込みに失敗しました:', error);
        }
      }
      
      // DOMContentLoadedより前に実行
      loadTailwindConfig();
    </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="js/data-loader.js"></script>
    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .template-tab.active {
        border-color: rgb(37 99 235);
        color: rgb(37 99 235);
        background-color: rgb(239 246 255);
      }

      .template-card {
        transition: all 0.2s ease-in-out;
      }

      .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      }

      /* スクロールバーを隠す */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex h-screen relative">
      <!-- サイドバー -->
      <aside
        class="w-60 text-white flex flex-col fixed lg:relative h-full z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 bg-green-gradient"
        id="sidebar"
      >
        <div class="flex-1 flex flex-col">
          <div class="px-6 pt-8 pb-6 border-b border-white/10">
            <div class="flex items-center justify-between">
              <h1 class="text-2xl font-bold">Golf Salon</h1>
              <span
                class="text-xs px-3 py-1 rounded font-semibold text-dark-green bg-gold-gradient"
                >ADMIN</span
              >
            </div>
          </div>

          <nav class="flex-1 py-4">
            <a
              href="admin-users.html"
              class="flex items-center gap-3 px-6 py-3.5 text-white/80 hover:bg-white/10 hover:text-white border-l-4 border-transparent hover:border-yellow-500 transition-all"
            >
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>ユーザー管理</span>
            </a>
            <a
              href="admin-contents.html"
              class="flex items-center gap-3 px-6 py-3.5 text-white/80 hover:bg-white/10 hover:text-white border-l-4 border-transparent hover:border-yellow-500 transition-all"
            >
              <i data-lucide="file-text" class="w-5 h-5"></i>
              <span>コンテンツ管理</span>
            </a>
            <a
              href="admin-emails.html"
              class="flex items-center gap-3 px-6 py-3.5 bg-white/15 border-l-4 border-yellow-500 text-white"
            >
              <i data-lucide="mail" class="w-5 h-5"></i>
              <span>メール管理</span>
            </a>
            <a
              href="admin-settings.html"
              class="flex items-center gap-3 px-6 py-3.5 text-white/80 hover:bg-white/10 hover:text-white border-l-4 border-transparent hover:border-yellow-500 transition-all"
            >
              <i data-lucide="settings" class="w-5 h-5"></i>
              <span>設定</span>
            </a>
          </nav>
        </div>

        <div class="px-6 py-6 border-t border-white/10">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center"
              >
                <i data-lucide="user" class="w-5 h-5"></i>
              </div>
              <div>
                <div class="text-sm font-medium">管理者</div>
                <div class="text-xs text-gray-400">admin@golfsalon.jp</div>
              </div>
            </div>
            <button
              class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white/10"
              title="ログアウト"
            >
              <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </aside>

      <!-- サイドバーオーバーレイ -->
      <div
        class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden"
        id="sidebarOverlay"
        onclick="toggleSidebar()"
      ></div>

      <!-- メインコンテンツ -->
      <main class="flex-1 overflow-y-auto">
        <!-- ヘッダー -->
        <header class="bg-white shadow-xs border-b">
          <div class="px-4 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <button
                class="lg:hidden p-2 hover:bg-gray-100 rounded-lg"
                onclick="toggleSidebar()"
              >
                <i data-lucide="menu" class="w-5 h-5"></i>
              </button>
              <h2 class="text-xl lg:text-2xl font-bold text-dark-green">
                メール管理
              </h2>
            </div>
          </div>
        </header>

        <!-- コンテンツ -->
        <div class="p-4 lg:p-8">
          <!-- 統計カード -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-blue-100 rounded-lg">
                  <i data-lucide="mail" class="w-6 h-6 text-blue-600"></i>
                </div>
              </div>
              <h3 class="text-2xl font-bold text-dark-green">17</h3>
              <p class="text-gray-600 text-sm">総送信数</p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-green-100 rounded-lg">
                  <i
                    data-lucide="check-circle"
                    class="w-6 h-6 text-green-600"
                  ></i>
                </div>
              </div>
              <h3 class="text-2xl font-bold text-dark-green">76.5%</h3>
              <p class="text-gray-600 text-sm">配信成功率</p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-red-100 rounded-lg">
                  <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                </div>
              </div>
              <h3 class="text-2xl font-bold text-dark-green">11.8%</h3>
              <p class="text-gray-600 text-sm">失敗率</p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 bg-orange-100 rounded-lg">
                  <i
                    data-lucide="alert-triangle"
                    class="w-6 h-6 text-orange-600"
                  ></i>
                </div>
              </div>
              <h3 class="text-2xl font-bold text-dark-green">5.9%</h3>
              <p class="text-gray-600 text-sm">バウンス率</p>
            </div>
          </div>

          <!-- フィルター -->
          <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-gray-900">絞り込み条件</h3>
              <button
                id="clearFiltersBtn"
                class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-1"
                onclick="clearFilters()"
              >
                <i data-lucide="x-circle" class="w-4 h-4"></i>
                クリア
              </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label
                  for="statusFilter"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >ステータス</label
                >
                <select
                  id="statusFilter"
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                >
                  <option value="">すべて</option>
                  <option value="sent">送信済み</option>
                  <option value="delivered">配信済み</option>
                  <option value="failed">失敗</option>
                  <option value="bounced">バウンス</option>
                  <option value="scheduled">スケジュール</option>
                  <option value="sending">送信中</option>
                </select>
              </div>
              <div>
                <label
                  for="templateFilter"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >テンプレート</label
                >
                <select
                  id="templateFilter"
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                >
                  <option value="">すべて</option>
                  <option value="welcome">ウェルカム</option>
                  <option value="payment_success">決済成功</option>
                  <option value="payment_failed">決済失敗</option>
                  <option value="password_reset">パスワードリセット</option>
                  <option value="plan_registration_complete">
                    プラン登録完了
                  </option>
                  <option value="email_change_verification">
                    メールアドレス変更確認
                  </option>
                  <option value="auto_billing_suspended">自動課金停止</option>
                  <option value="cancellation_started">退会手続き開始</option>
                </select>
              </div>
              <div>
                <label
                  for="dateFilter"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >期間</label
                >
                <select
                  id="dateFilter"
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                >
                  <option value="">すべて</option>
                  <option value="today">今日</option>
                  <option value="week">今週</option>
                  <option value="month">今月</option>
                </select>
              </div>
            </div>
          </div>

          <!-- メール送信履歴テーブル -->
          <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="overflow-x-auto">
              <table class="w-full min-w-[900px]">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      <div class="flex items-center gap-1">
                        送信日時
                        <i
                          data-lucide="arrow-down"
                          class="w-3 h-3 text-gray-400"
                        ></i>
                      </div>
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      宛先
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      件名
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      テンプレート
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      ステータス
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      配信時間
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      操作
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="emailTableBody"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- メールログがここに動的に挿入されます -->
                </tbody>
              </table>
            </div>

            <!-- ページング -->
            <div
              id="emailPagination"
              class="flex items-center justify-between px-6 py-3 bg-white border-t border-gray-200"
            >
              <div class="flex items-center text-sm text-gray-700">
                <span id="paginationInfo">1-10 of 13 results</span>
              </div>
              <div class="flex items-center space-x-2">
                <button
                  id="prevPageBtn"
                  class="px-3 py-1 text-sm text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
                <div id="pageNumbers" class="flex items-center space-x-1">
                  <!-- ページ番号がここに動的に挿入されます -->
                </div>
                <button
                  id="nextPageBtn"
                  class="px-3 py-1 text-sm text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- ダッシュボードセクション -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- メールテンプレート -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
              <!-- ヘッダー -->
              <div class="p-6 border-b border-gray-200">
                <h3
                  class="text-lg font-semibold text-dark-green flex items-center gap-2"
                >
                  <i data-lucide="file-text" class="w-5 h-5"></i>
                  メールテンプレート
                </h3>
              </div>

              <!-- タブナビゲーション -->
              <div class="border-b border-gray-200">
                <nav class="flex overflow-x-auto scrollbar-hide">
                  <button
                    id="tab-account"
                    class="template-tab flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-primary-600 text-primary-600 bg-primary-50 whitespace-nowrap"
                    onclick="switchTemplateTab('account')"
                  >
                    アカウント
                  </button>
                  <button
                    id="tab-billing"
                    class="template-tab flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap"
                    onclick="switchTemplateTab('billing')"
                  >
                    決済・課金
                  </button>
                  <button
                    id="tab-subscription"
                    class="template-tab flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap"
                    onclick="switchTemplateTab('subscription')"
                  >
                    契約管理
                  </button>
                </nav>
              </div>

              <!-- テンプレートリスト -->
              <div class="p-6">
                <div id="templateList" class="space-y-4">
                  <!-- テンプレートアイテムがJavaScriptで動的に生成されます -->
                </div>
              </div>
            </div>

            <!-- 配信失敗とResend連携 -->
            <div class="space-y-6">
              <!-- 配信失敗一覧 -->
              <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <h3 class="text-base font-medium text-gray-900">
                      配信失敗一覧
                    </h3>
                    <span id="failedEmailCount" class="text-sm text-gray-500">
                      0件
                    </span>
                  </div>
                </div>

                <div id="failedEmailsList" class="divide-y divide-gray-200">
                  <!-- 失敗メールがここに動的に挿入されます -->
                </div>
              </div>

              <!-- Resend連携状況 -->
              <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                <h3
                  class="text-base sm:text-lg font-semibold text-dark-green mb-4 flex items-center gap-2"
                >
                  <i data-lucide="link" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                  Resend連携状況
                </h3>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-xs sm:text-sm text-gray-600"
                      >接続ステータス</span
                    >
                    <span class="text-xs sm:text-sm font-medium text-green-600"
                      >接続中</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-xs sm:text-sm text-gray-600"
                      >月次クォータ</span
                    >
                    <span class="text-xs sm:text-sm font-medium text-gray-900"
                      >1,892 / 3,000</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-xs sm:text-sm text-gray-600"
                      >API成功率</span
                    >
                    <span class="text-xs sm:text-sm font-medium text-green-600"
                      >98.7%</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-xs sm:text-sm text-gray-600"
                      >最終Webhook</span
                    >
                    <span class="text-xs sm:text-sm font-medium text-gray-900"
                      >2025/07/18 12:30</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- メール詳細モーダル -->
    <div
      id="emailDetailModal"
      class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden"
      >
        <!-- ヘッダー -->
        <div class="flex items-center justify-between p-6 border-b">
          <h3 class="text-lg font-semibold text-gray-900">メール詳細</h3>
          <button
            onclick="closeEmailDetailModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <!-- コンテンツ -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 基本情報 -->
            <div class="space-y-4">
              <h4 class="text-md font-semibold text-gray-800 border-b pb-2">
                基本情報
              </h4>

              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-600"
                    >件名</label
                  >
                  <p
                    id="modal-subject"
                    class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                  ></p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-600"
                      >送信者</label
                    >
                    <p
                      id="modal-from-email"
                      class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                    ></p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-600"
                      >宛先</label
                    >
                    <p
                      id="modal-to-email"
                      class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                    ></p>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-600"
                      >テンプレート</label
                    >
                    <p
                      id="modal-template"
                      class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                    ></p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-600"
                      >ステータス</label
                    >
                    <div id="modal-status-container"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 送信情報 -->
            <div class="space-y-4">
              <h4 class="text-md font-semibold text-gray-800 border-b pb-2">
                送信情報
              </h4>

              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-600"
                    >Resend Email ID</label
                  >
                  <p
                    id="modal-resend-id"
                    class="text-sm text-gray-900 bg-gray-50 p-2 rounded font-mono"
                  ></p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-600"
                      >送信日時</label
                    >
                    <p
                      id="modal-sent-at"
                      class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                    ></p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-600"
                      >配信日時</label
                    >
                    <p
                      id="modal-delivered-at"
                      class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                    ></p>
                  </div>
                </div>

                <div id="modal-error-section" class="hidden">
                  <label class="block text-sm font-medium text-red-600"
                    >エラー情報</label
                  >
                  <div class="bg-red-50 border border-red-200 rounded p-3">
                    <p
                      id="modal-error-message"
                      class="text-sm text-red-700"
                    ></p>
                    <p
                      id="modal-error-type"
                      class="text-xs text-red-600 mt-1"
                    ></p>
                  </div>
                </div>

                <div id="modal-bounce-section" class="hidden">
                  <label class="block text-sm font-medium text-orange-600"
                    >バウンス情報</label
                  >
                  <div
                    class="bg-orange-50 border border-orange-200 rounded p-3"
                  >
                    <p
                      id="modal-bounce-message"
                      class="text-sm text-orange-700"
                    ></p>
                    <div class="flex gap-4 mt-2">
                      <span class="text-xs text-orange-600"
                        >Code: <span id="modal-bounce-code"></span
                      ></span>
                      <span class="text-xs text-orange-600"
                        >Enhanced: <span id="modal-bounce-enhanced"></span
                      ></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Webhook情報 -->
          <div class="mt-6 pt-6 border-t">
            <h4 class="text-md font-semibold text-gray-800 mb-4">
              Webhook情報
            </h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-600"
                  >最新Webhookタイプ</label
                >
                <p
                  id="modal-webhook-type"
                  class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                ></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600"
                  >最新Webhook受信時刻</label
                >
                <p
                  id="modal-webhook-at"
                  class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                ></p>
              </div>
            </div>
          </div>

          <!-- 再試行情報 -->
          <div id="modal-retry-section" class="mt-6 pt-6 border-t">
            <h4 class="text-md font-semibold text-gray-800 mb-4">再試行情報</h4>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-600"
                  >再試行回数</label
                >
                <p
                  id="modal-retry-count"
                  class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                ></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600"
                  >再試行可能</label
                >
                <p
                  id="modal-can-retry"
                  class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                ></p>
              </div>
              <div id="modal-next-retry-container">
                <label class="block text-sm font-medium text-gray-600"
                  >次回再試行</label
                >
                <p
                  id="modal-next-retry"
                  class="text-sm text-gray-900 bg-gray-50 p-2 rounded"
                ></p>
              </div>
            </div>
          </div>
        </div>

        <!-- フッター -->
        <div
          class="flex items-center justify-end gap-3 p-6 border-t bg-gray-50"
        >
          <button
            onclick="closeEmailDetailModal()"
            class="px-4 py-2 text-gray-600 hover:text-gray-800"
          >
            閉じる
          </button>
          <button
            id="modal-resend-btn"
            onclick="resendEmailFromModal()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hidden"
          >
            再送信
          </button>
        </div>
      </div>
    </div>

    <!-- 配信失敗詳細・解決モーダル -->
    <div
      id="investigationModal"
      class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-hidden"
      >
        <!-- ヘッダー -->
        <div class="flex items-center justify-between p-6 border-b">
          <h3 class="text-lg font-semibold text-gray-900">
            配信失敗詳細・対応記録
          </h3>
          <button
            onclick="closeInvestigationModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <!-- コンテンツ -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
          <!-- 基本情報 -->
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">基本情報</h4>
            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">宛先</span>
                <span
                  id="modal-investigation-email"
                  class="text-sm font-medium text-gray-900"
                ></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">エラー</span>
                <span
                  id="modal-investigation-error"
                  class="text-sm text-red-600"
                ></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">発生日時</span>
                <span
                  id="modal-investigation-date"
                  class="text-sm text-gray-900"
                ></span>
              </div>
            </div>
          </div>

          <!-- エラー分析 -->
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">エラー分析</h4>
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
              <div class="flex items-start gap-3">
                <i
                  data-lucide="alert-triangle"
                  class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"
                ></i>
                <div class="flex-1 space-y-2">
                  <div>
                    <span class="text-sm font-medium text-gray-700"
                      >分類:
                    </span>
                    <span
                      id="modal-investigation-category"
                      class="text-sm text-gray-900"
                    ></span>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-700"
                      >重要度:
                    </span>
                    <span
                      id="modal-investigation-severity"
                      class="text-sm"
                    ></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 推奨対応 -->
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">推奨対応</h4>
            <div id="modal-investigation-recommendations" class="space-y-2">
              <!-- 推奨事項がここに動的に挿入されます -->
            </div>
          </div>

          <!-- 技術詳細 -->
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">技術詳細</h4>
            <div class="bg-gray-50 rounded-lg p-4 font-mono text-xs space-y-1">
              <div>
                <span class="text-gray-600">Resend ID:</span>
                <span
                  id="modal-investigation-resend-id"
                  class="text-gray-900"
                ></span>
              </div>
              <div>
                <span class="text-gray-600">Webhook:</span>
                <span
                  id="modal-investigation-webhook"
                  class="text-gray-900"
                ></span>
              </div>
            </div>
          </div>

          <!-- 対応ステータスと解決方法 -->
          <div id="resolutionSection" class="pt-6 border-t">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">
              対応ステータス
            </h4>
            <div class="space-y-3">
              <label
                class="flex items-start gap-3 p-4 border rounded-lg cursor-pointer hover:bg-gray-50"
              >
                <input
                  type="radio"
                  name="status"
                  value="investigating"
                  class="mt-1"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-900">調査中</div>
                  <div class="text-sm text-gray-600 mt-1">原因を調査中</div>
                </div>
              </label>

              <label
                class="flex items-start gap-3 p-4 border rounded-lg cursor-pointer hover:bg-gray-50"
              >
                <input
                  type="radio"
                  name="status"
                  value="resolved"
                  class="mt-1"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-900">解決済み</div>
                  <div class="text-sm text-gray-600 mt-1">
                    問題が解決し、今後は正常に配信可能
                  </div>
                </div>
              </label>

              <label
                class="flex items-start gap-3 p-4 border rounded-lg cursor-pointer hover:bg-gray-50"
              >
                <input
                  type="radio"
                  name="status"
                  value="unresolvable"
                  class="mt-1"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-900">解決不可</div>
                  <div class="text-sm text-gray-600 mt-1">
                    恒久的な問題で解決不可能
                  </div>
                </div>
              </label>
            </div>

            <!-- 解決不可の場合の追加オプション -->
            <div id="unresolvableOptionsInv" class="mt-4 hidden">
              <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                <label class="flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="suppressFutureEmailsInv"
                    class="rounded"
                  />
                  <span class="text-sm text-gray-700"
                    >今後このアドレスへの配信を停止（抑制リストに追加）</span
                  >
                </label>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >理由</label
                  >
                  <select
                    id="unresolvableReasonInv"
                    class="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">選択してください</option>
                    <option value="invalid_email">無効なメールアドレス</option>
                    <option value="user_deleted">ユーザー退会済み</option>
                    <option value="permanent_bounce">恒久的なバウンス</option>
                    <option value="spam_complaint">スパム報告</option>
                    <option value="other">その他</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 対応メモ -->
            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >対応メモ</label
              >
              <textarea
                id="investigationNotes"
                rows="3"
                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 field-sizing-content"
                placeholder="調査結果や対応内容を記録してください..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- フッター -->
        <div
          class="flex items-center justify-end gap-3 p-6 border-t bg-gray-50"
        >
          <button
            onclick="closeInvestigationModal()"
            class="px-4 py-2 text-gray-600 hover:text-gray-800"
          >
            キャンセル
          </button>
          <button
            id="modal-save-status-btn"
            onclick="saveFailureStatus()"
            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            保存
          </button>
        </div>
      </div>
    </div>


    <script src="js/admin-emails.js"></script>
  </body>
</html>
